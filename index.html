<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Portal de Alertas – Remessas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#050814;
  --card:#0b1020;
  --accent:#ff8c1a;
  --ok:#2ecc71;
  --warn:#f1c40f;
  --grave:#f39c12;
  --action:#e74c3c;
  --text:#f5f7ff;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:radial-gradient(circle at top,#1a1f33,#050814 60%);
  color:var(--text);
}

#login{min-height:100vh;display:flex;justify-content:center;align-items:center}
.login-card{
  width:420px;background:linear-gradient(180deg,#0d1224,#070b16);border-radius:20px;
  padding:32px;box-shadow:0 20px 60px rgba(0,0,0,.6);text-align:center;
}
.login-card img{width:140px;margin-bottom:16px;filter:brightness(1.2)}
.login-card h1{margin:0}
.login-card p{opacity:.8}
.login-card input, .form-grid input{
  width:100%;padding:12px;margin-top:10px;border-radius:12px;border:none;background:#0b1020;color:white;
}
.login-card button, button.small{
  margin-top:16px;padding:10px 14px;border:none;border-radius:10px;background:var(--accent);font-weight:700;cursor:pointer;
}
button.small{margin-top:0;background:#121a33;color:white}

#app{display:none;padding:24px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
header .left{display:flex;align-items:center;gap:16px}
header img{width:56px;filter:brightness(1.1)}
.card{background:linear-gradient(180deg,#0c1226,#070b16);border-radius:20px;padding:20px;margin-bottom:20px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.stat{border-left:6px solid}.stat.ok{border-color:var(--ok)}.stat.warn{border-color:var(--warn)}
.stat.grave{border-color:var(--grave)}.stat.action{border-color:var(--action)}
.stat h2{margin:0;font-size:18px}.stat span{font-size:32px;font-weight:700}

.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;min-width:700px}
th{background:var(--accent);padding:10px;text-align:left;color:#050814}
td{padding:8px;border-bottom:1px solid #1c2544}
.admin-only{display:none}
.form-grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px;align-items:end}
.form-grid .full{grid-column:span 2}
.tag{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block}
.tag.emitida{background:#2ecc7128;color:#9ef8c0}
.tag.pendente{background:#f1c40f2b;color:#ffe78d}
.tag.cancelada{background:#e74c3c2d;color:#ffb1a8}
.actions{display:flex;gap:6px;flex-wrap:wrap}

@media (max-width:960px){
  .grid{grid-template-columns:repeat(2,1fr)}
  .form-grid{grid-template-columns:repeat(2,minmax(130px,1fr))}
}
</style>
</head>

<body>
<div id="login">
  <div class="login-card">
    <img src="logo-areia-ana.png" alt="Logo">
    <h1>Portal de Alertas</h1>
    <p>Remessas • Contratos • Status automático</p>
    <input id="user" placeholder="Usuário">
    <input id="pass" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>
</div>

<div id="app">
<header>
  <div class="left">
    <img src="logo-areia-ana.png" alt="Logo">
    <h2>Portal de Alertas – Remessas</h2>
  </div>
  <div>
    <span id="perfil"></span>
    <button class="small" onclick="logout()">Sair</button>
  </div>
</header>

<div class="card grid">
  <div class="stat ok"><h2>OK</h2><span id="ok">0</span></div>
  <div class="stat warn"><h2>Atenção</h2><span id="warn">0</span></div>
  <div class="stat grave"><h2>Atenção Grave</h2><span id="grave">0</span></div>
  <div class="stat action"><h2>Plano de Ação</h2><span id="action">0</span></div>
</div>

<div class="card admin-only">
  <h3>Administração de remessas</h3>
  <input type="file" id="file">
  <button class="small" onclick="importCSV()">Importar</button>
  <button class="small" onclick="clearData()">Excluir Dados</button>
</div>

<div class="card">
  <h3>Operação (MVP pedido → nota)</h3>
  <div class="form-grid">
    <input id="pedidoCliente" placeholder="Cliente" class="full">
    <input id="pedidoMaterial" placeholder="Material">
    <input id="pedidoQtd" type="number" min="1" value="1" placeholder="Qtd">
    <input id="pedidoDestino" placeholder="Destino" class="full">
    <input id="pedidoData" type="date">
    <button class="small" onclick="criarPedido()">Criar pedido</button>
  </div>
  <div class="table-wrap" style="margin-top:14px">
    <table>
      <thead>
        <tr>
          <th>Pedido</th><th>Cliente</th><th>Material</th><th>Qtd</th><th>Destino</th><th>Status</th><th>Nota</th><th>Ações</th>
        </tr>
      </thead>
      <tbody id="pedidosBody"></tbody>
    </table>
  </div>
</div>

<div class="card table-wrap">
  <h3>Detalhamento</h3>
  <table>
    <thead>
      <tr><th>Cliente</th><th>Contrato</th><th>Última Remessa</th><th>Dias</th><th>Status</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</div>

<script>
const users={admin:{pass:"1234",role:"Administrador"},usuario:{pass:"1234",role:"Usuário"}};
let data=[];
let pedidos=[];

function safeParse(key){
  try{return JSON.parse(localStorage.getItem(key)||"[]")}catch(_){
    localStorage.removeItem(key);
    return [];
  }
}

const elements={
  login:document.getElementById("login"),app:document.getElementById("app"),perfil:document.getElementById("perfil"),
  ok:document.getElementById("ok"),warn:document.getElementById("warn"),grave:document.getElementById("grave"),action:document.getElementById("action"),
  tbody:document.getElementById("tbody"),pedidosBody:document.getElementById("pedidosBody"),adminOnly:[...document.querySelectorAll(".admin-only")]
};

function showLogin(){elements.login.style.display="flex";elements.app.style.display="none"}
function showApp(){elements.login.style.display="none";elements.app.style.display="block"}

function login(){
  const u=document.getElementById("user").value;
  const p=document.getElementById("pass").value;
  if(!users[u]||users[u].pass!==p)return alert("Login inválido");
  localStorage.setItem("user",u);init();
}

function logout(){localStorage.removeItem("user");location.reload()}

function init(){
  const u=localStorage.getItem("user");
  if(!u||!users[u]){localStorage.removeItem("user");showLogin();return}

  showApp();
  elements.perfil.innerText="Perfil: "+users[u].role;
  elements.adminOnly.forEach(e=>e.style.display=users[u].role==="Administrador"?"block":"none");

  data=safeParse("data");
  pedidos=safeParse("pedidos");

  render();
  renderPedidos();
}

function importCSV(){
  const file=document.getElementById("file").files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const rows=e.target.result.split("\n").slice(1);
    data=rows.filter(Boolean).map(r=>{const c=r.split(",");return{cliente:c[0]||"",contrato:c[1]||"",data:c[2]||"",dias:parseInt(c[3]||0)}});
    localStorage.setItem("data",JSON.stringify(data));render();
  };
  reader.readAsText(file,"UTF-8");
}

function clearData(){if(confirm("Excluir todos os dados?")){localStorage.removeItem("data");data=[];render()}}
function status(d){if(d<=7)return["OK","ok"];if(d<=14)return["Atenção","warn"];if(d<=21)return["Atenção Grave","grave"];return["Plano de Ação","action"]}

function render(){
  elements.ok.innerText=elements.warn.innerText=elements.grave.innerText=elements.action.innerText=0;
  elements.tbody.innerHTML="";
  data.forEach(r=>{
    const [s,c]=status(r.dias);
    document.getElementById(c).innerText++;
    elements.tbody.innerHTML+=`<tr><td>${r.cliente}</td><td>${r.contrato}</td><td>${r.data}</td><td>${r.dias}</td><td>${s}</td></tr>`;
  });
}

function uid(prefix){return `${prefix}-${Date.now()}-${Math.floor(Math.random()*90+10)}`}

function criarPedido(){
  const cliente=document.getElementById("pedidoCliente").value.trim();
  const material=document.getElementById("pedidoMaterial").value.trim();
  const qtd=parseInt(document.getElementById("pedidoQtd").value||"0");
  const destino=document.getElementById("pedidoDestino").value.trim();
  const dataEntrega=document.getElementById("pedidoData").value;
  if(!cliente||!material||!qtd||!destino||!dataEntrega)return alert("Preencha cliente, material, quantidade, destino e data.");
  pedidos.unshift({
    id:uid("PED"),cliente,material,qtd,destino,dataEntrega,
    status:"Pendente",nota:null
  });
  persistPedidos();
  ["pedidoCliente","pedidoMaterial","pedidoDestino","pedidoData"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("pedidoQtd").value=1;
}

function persistPedidos(){localStorage.setItem("pedidos",JSON.stringify(pedidos));renderPedidos()}

function emitirNota(id){
  pedidos=pedidos.map(p=>{
    if(p.id!==id)return p;
    if(p.status==="Cancelado")return p;
    return {...p,status:"Nota emitida",nota:{numero:Math.floor(Math.random()*90000+10000),chave:uid("NFE")}};
  });
  persistPedidos();
}

function cancelarPedido(id){
  pedidos=pedidos.map(p=>p.id===id?{...p,status:"Cancelado",nota:null}:p);
  persistPedidos();
}

function confirmarEntrega(id){
  pedidos=pedidos.map(p=>p.id===id?{...p,status:"Entregue"}:p);
  persistPedidos();
}

function redirecionarPedido(id){
  const novoDestino=prompt("Novo destino para redirecionamento:");
  if(!novoDestino)return;
  pedidos=pedidos.map(p=>p.id===id?{...p,status:"Redirecionado",destino:novoDestino}:p);
  persistPedidos();
}

function renderPedidos(){
  elements.pedidosBody.innerHTML="";
  if(!pedidos.length){
    elements.pedidosBody.innerHTML='<tr><td colspan="8">Nenhum pedido cadastrado.</td></tr>';
    return;
  }
  pedidos.forEach(p=>{
    const nota=p.nota?`${p.nota.numero}`:"-";
    const cls=p.status==="Cancelado"?"cancelada":p.status==="Nota emitida"||p.status==="Entregue"?"emitida":"pendente";
    elements.pedidosBody.innerHTML+=`<tr>
      <td>${p.id}</td>
      <td>${p.cliente}</td>
      <td>${p.material}</td>
      <td>${p.qtd}</td>
      <td>${p.destino}</td>
      <td><span class="tag ${cls}">${p.status}</span></td>
      <td>${nota}</td>
      <td class="actions">
        <button class="small" onclick="emitirNota('${p.id}')">Emitir</button>
        <button class="small" onclick="cancelarPedido('${p.id}')">Cancelar</button>
        <button class="small" onclick="redirecionarPedido('${p.id}')">Redirecionar</button>
        <button class="small" onclick="confirmarEntrega('${p.id}')">Entregue</button>
      </td>
    </tr>`;
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  try{
    init();
  }catch(err){
    console.error("Falha ao iniciar o portal:", err);
    showLogin();
    alert("Ocorreu um erro ao carregar dados locais. Tente limpar o cache do navegador.");
  }
});
</script>
</body>
</html>
