name: Processar SQL42 (alertas + issue + email)

on:
  push:
    paths:
      - "data/**"
      - "scripts/**"

permissions:
  contents: write
  issues: write

jobs:
  processar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar depend√™ncias
        run: pip install pandas openpyxl

      - name: Gerar alerts.json
        run: python scripts/gerar_alertas_sql42.py

      - name: Commit alerts.json
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add portal/alerts.json
          git commit -m "Atualiza alerts.json [skip ci]" || echo "Sem mudan√ßas"
          git push

      - name: Atualizar Issue (notifica√ß√£o do GitHub)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("portal/alerts.json","utf8"));
            const title = "ALERTAS ‚Äì Clientes sem remessa (> 7 dias)";
            const total = data.total_plano_de_acao || 0;

            let body = `Gerado em: ${data.gerado_em}\nPlano de a√ß√£o (>7 dias): ${total}\n\n`;
            if (total === 0) {
              body += "‚úÖ Nenhum cliente acima de 7 dias sem remessa.";
            } else {
              body += "| Cliente | √öltima remessa | Dias | A√ß√£o |\n|---|---:|---:|---|\n";
              let shown = 0;
              for (const r of data.registros) {
                if (r.Status !== "PLANO_DE_ACAO") continue;
                body += `| ${r.CodCliente} - ${r.NomeCliente} | ${r.DataUltimaRemessa} | ${r.DiasSemRemessa} | ${r.Acao} |\n`;
                shown++;
                if (shown >= 200) break;
              }
              body += "\nAbra o portal e clique no üîî para filtrar Plano de a√ß√£o.";
            }

            const { owner, repo } = context.repo;
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: "open" });
            const existing = issues.data.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.update({ owner, repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }

      - name: Enviar e-mail (se tiver plano de a√ß√£o)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          ALERT_RECIPIENTS: ${{ secrets.ALERT_RECIPIENTS }}
        run: python scripts/enviar_email.py
